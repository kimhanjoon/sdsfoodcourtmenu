<!DOCTYPE html>
<html>
<head>
<title>delacourt at a glance</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/handsontable/0.29.1/handsontable.full.min.css">
</head>
<body>

<div class="container-fluid">

<button type="button" class="btn btn-primary btn-sm pull-right" id="send">전송</button>
<button type="button" class="btn btn-primary btn-sm pull-right" id="convert">변환</button>
<button type="button" class="btn btn-primary btn-sm pull-right" id="loadExample">예제</button>

<div class="page-header">
	<h2>delacourt <small>at a glance</small></h2>
</div>

<div id="schedule">
</div>
</div>


<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/handsontable/0.29.1/handsontable.full.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
<script>

$(function() {

	hot = new Handsontable($("#schedule").get(0), {
		data: Handsontable.helper.createEmptySpreadsheetData(100, 10),
		colWidths: 100,
		contextMenu: true
	});

	$("#loadExample").click(function() {

		var exampleData = JSON.parse('[["판교Campus 식단차림표 ","","","","","","","","",""],["","","","1/23 (월)","1/24 (화)","1/25 (수)","1/26 (목)","1/27 (금)","",""],["Morning\\n조식","탕맛기픈\\n2,500","","황태미역국","쇠고기당면국(우육:호주산)","고등어구이(고등어:국내산)","장터국밥(우육:호주산/우사골농축액:호주산)","\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n설연휴","",""],["","","","잡곡밥/쌀밥","잡곡밥/쌀밥","잡곡밥/쌀밥","잡곡밥/쌀밥","","",""],["","","","고기완자채소조림(돈육:국내산)","로스팜구이(돈육:수입산)","아욱된장국","꼬마돈가스케찹조림(돈육,계육:국내산)","","",""],["","","","두부찜*양념장","잔멸치호두볶음","새송이곤약조림","건새우마늘쫑볶음","","",""],["","","","고추지무침","볶음김치","깻잎지무침","석박지","","",""],["","","","포기김치","","포기김치","","","",""],["","추가배식대","","누룽지","누룽지","누룽지","누룽지","","",""],["","Health Giving 365\\n(아메리칸블랙퍼스트)\\n3,000\\n(빵2종선택)","","토스트/버터롤빵/치즈케익/땅콩크림빵","토스트/버터롤빵/애플턴오버/초코패스트리","토스트/버터롤빵/크림치즈파이/꿀호떡빵","토스트/버터롤빵/핫케익/모카크림빵","","",""],["","","","비엔나파인애플볶음(계육:국산,돈육:외국산/국산)","고구마버터구이","베이컨구이(돈육:수입산)","살라미햄구이(돈육:국내산/우육:호주산)","","",""],["","","","계란후라이","미트볼커리(돈육:국내산)","계란후라이","푸실리케찹볶음","","",""],["","","","그린샐러드*키위,오리엔탈D","그린샐러드*딸기,발사믹D","그린샐러드*자몽,오리엔탈D","그린샐러드*요거트,발사믹D","","",""],["","","","크림스프","브로콜리스프","단호박스프","크림스프","","",""],["","","","플레인요거트","감자샐러드","마카로니샐러드","단호박샐러드","","",""],["","","","콘&초코첵스","콘&초코링","콘&아몬드후레이크","콘&초코첵스","","",""],["","","","커피/사과주스/우유","커피/배주스/우유","커피/당근주스/우유","커피/토마토주스/우유","","",""],["","","","바나나","거봉","사과","오렌지","","",""],["","Snap \\nSnack\\n","라면2,500","수제비라면","꼬치어묵라면","참깨라면","진짬뽕라면","","",""],["","","죽\\n2,500","단호박죽","바지락채소죽","참치채소죽","쇠고기채소죽(우육:호주산)","","",""],["","Take\\nme\\nout\\n","김밥\\n2,000","야채김밥(돈육:국산,수입산/계육:국산)","볶음김치김밥(돈육:국산,수입산/계육:국산)","스팸김밥(돈육:수입산)","참치김밥(돈육:국산,수입산/계육:국산)","","",""],["","","","일식장국","미역국","콩나물국","미역국","","",""],["","","","음료","음료","음료","음료","","",""],["","","김밥set\\n2,500","야채김밥(돈육:국산,수입산/계육:국산)","볶음김치김밥(돈육:국산,수입산/계육:국산)","스팸김밥(돈육:수입산)","참치김밥(돈육:국산,수입산/계육:국산)","","",""],["","","","일식장국","미역국","콩나물국","미역국","","",""],["","","","시리얼바&바나나","파인,오렌지&양배추샐러드","컵젤리&바나나","고구마범벅&후르츠샐러드","","",""],["","","","음료","음료","음료","음료","","",""],["","","샌드위치set\\n2,500","햄에그샌드위치","핫도그샌드위치(돈육:외국산,국산)","감자샐러드샌드위치(돈육:국산,수입산/계육:국산)","치킨앤포테이토샌드위치","","",""],["","","","시리얼바&바나나","파인,오렌지&양배추샐러드","컵젤리&바나나","고구마범벅&후르츠샐러드","","",""],["","","","음료","음료","음료","음료","","",""],["","","과일팩\\n2,500","과일 4종","과일 4종","과일 4종","과일 4종","","",""],["","","","(파인애플,거봉,바나나,오렌지)","(파인애플,키위,감귤,바나나)","(파인애플,토마토,사과,메론)","(오렌지,바나나,키위,거봉)","","",""],["","","착즙주스\\n3,000","오스트레일리아","클린그린엘릭서","골드스킨","BBQ블로우아웃","","",""],["","","Healthy\\nBOX\\n3,000","케이준치킨텐더샐러드(계육:국내산)","치킨너겟그린샐러드(계육:국내산)","훈제오리샐러드(오리:국내산)","견과류닭가슴살샐러드(계육:국내산)","","",""],["","","","새송이버섯구이","게맛살주먹밥","블랙올리브포카차","채소스틱","","",""],["","","","파인애플","키위","오렌지","사과","","",""],["Lunch\\n중식","탕맛기픈\\n3,000\\nP3,500","","쇠고기대파해장국(우육:호주산)","잔치국수(우육:호주산)","영양닭죽(계육:국내산/닭뼈:국내산)","사골떡만둣국(우사골농축액:호주산)","","",""],["","","","잡곡밥/쌀밥","우엉양념밥","잡곡밥/쌀밥","잡곡밥/쌀밥","","",""],["","","","매콤잡채어묵조림","오징어채소초무침(오징어:대만산)","비빔채소만두","메추리알조림","","",""],["","","","느타리호박볶음","검은깨올방개묵","명엽채볶음","꽈리고추게맛살볶음","","",""],["","","","허브생채","배추겉절이(배추:국내산/고춧가루:중국산)","오이쌈장무침","숙주부추나물","","",""],["","","","깍두기","요구르트","동치미","깍두기","","",""],["","도담찌개\\n3,000\\nP3,500","","참치김치찌개","명란순두부찌개(명란:미국산)","뚝배기유자향돼지불고기(돈육:미국산)","P.훈제오리(오리:국내산)*부추생채","","",""],["","","","잡곡밥/쌀밥","잡곡밥/쌀밥","잡곡밥/쌀밥","잡곡밥/쌀밥","","",""],["","","","남도떡갈비구이(돈육:국산/우육:호주산,국산)","도톰완자전(돈육:국내산)","얼큰콩나물국","근대된장국","","",""],["","","","매운알감자조림","김구이","명엽채볶음","매콤어묵볶음","","",""],["","","","허브생채","무말랭이무침","모듬채소겉절이","쌈무","","",""],["","","","깍두기","포기김치","포기김치","포기김치","","",""],["","가츠엔\\n3,000\\nP3,500","","계란말이스팸덮밥(로스팜\\"돈육:수입산)","P.도쿄함박스테이크&계란후라이\\n(우육:호주산/돈육:국내산)","미트볼하이라이스(돈육:국내산)","등심돈가스(돈육:국내산)*칠리소스","","",""],["","","","유부장국","쌀밥/크림스프","팽이버섯장국","쌀밥/옥수수스프","","",""],["","","","꽈배기도너츠","버터롤빵/그린샐러드*드레싱","몬테크리스토(돈육:국내산)","그린샐러드*드레싱","","",""],["","","","무비트피클/볶음김치","오이피클/포기김치","오이피클/포기김치","오이피클/포기김치","","",""],["","싱푸차이나\\n3,000\\nP3,500","","P.베트남양지쌀국수(우육:호주산)","몽골리안바베큐덮밥(계육:브라질산/\\n돈육:미국산/우육:호주산)","P.꼬치어묵짬뽕(오징어:칠레산)","후난식볶음밥(돈육:미국산/오징어:칠레산)\\n&짜장소스","","",""],["","","","채소볶음밥","일식장국","쌀밥","빠이탕","","",""],["","","","돈육강정(돈육:국내산)","팥춘권","연유꽃빵튀김","물만두","","",""],["","","","양파초절임/포기김치","단무지무침/포기김치","단무지/포기김치","단무지/포기김치","","",""],["","Health Giving 365\\n3,000\\nP3,500","","매콤제육덮밥(돈육:미국산)","꽁치묵은지조림","오색나물돌솥비빔밥*계란후라이","사골떡만둣국(우사골농축액:호주산)","","ㅣ",""],["","","","시금치된장국","잡곡밥/쌀밥/시락국","유부장국","잡곡밥/쌀밥","","",""],["","","","엄지새송이버섯볶음","부추전","포테이토고로케","메추리알조림","","",""],["","","","해초샐러드","어묵미역줄기볶음","청포묵김가루무침","꽈리고추게맛살볶음","","",""],["","","","포기김치","깍두기","포기김치","숙주부추나물/깍두기","","",""],["","Snap \\nSnack\\n","스낵\\n3,000","브런치(베이컨\\"돈육:수입산/햄\\"돈육:국산)","브런치(베이컨\\"돈육:수입산/햄\\"돈육:국산)","브런치(베이컨\\"돈육:수입산/햄\\"돈육:국산)","브런치(베이컨\\"돈육:수입산/햄\\"돈육:국산)","","",""],["","","라면\\n2,500","수제비라면","꼬치어묵라면","참깨라면","진짬뽕라면","","",""],["","Take\\nme\\nout\\n\\n","9첩도시락\\n3,500","대파돼지고기불고기(돈육:국내산)","닭가슴살채소불고기(계육:국내산)","쇠고기장조림(우육:호주산)","담양떡갈비(우육:호주산/돈육:국내산)","","",""],["","","","진미채무침(오징어:페루산)","","","","","",""],["","","착즙주스\\n3,000","오스트레일리아","클린그린엘릭서","골드스킨","BBQ블로우아웃","","",""],["","","샐러드팩\\n3,000","베이컨에그샐러드(돈육:수입산)","구운단호박그린샐러드","구운닭가슴살샐러드(계육:국내산)","훈제연어샐러드","","",""],["","","콤보\\n3,000","햄치즈샌드위치","치킨데리야끼샌드위치(계육:국내산)","튜나샌드위치","허니머스타드치킨샌드위치(계육:브라질산)","","",""],["","","김밥콤보\\n3,500","떡갈비김밥(우육:호주산/돈육:국내산)","너비아니김밥(돈육,계육:국내산)","매콤멸치김밥(돈육:국산,수입산/계육:국산)","치즈김밥(돈육:국산,수입산/계육:국산)","","",""],["","","","오미산적(돈육,계육:국내산)","새우튀김","계란말이","직화너비아니구이(돈육:수입산)","","",""],["Dinner\\n석식","탕맛기픈\\nor\\n도담찌개\\n3,000\\nP.3.500","","도담찌개","도담찌개","도담찌개","석식축소운영","","",""],["","","","얼큰어묵전골","김치볶음밥&계란후라이\\n(햄\\"돈육:국산,수입산/계육:국산)","P.불고기열무비빔밥(우육:호주산)*강된장","","","",""],["","","","잡곡밥/쌀밥","홍합국","미역국","","","",""],["","","","너비아니계란전(돈육,계육:국내산)","단호박부꾸미","메밀배추전","","","",""],["","","","연근아몬드조림","실곤약채소무침","우엉땅콩조림","","","",""],["","","","다시마숙회*초장","깍두기","깍두기","","","",""],["","","","포기김치","","","","","",""],["","싱푸or가츠엔\\nor\\nHealth Giving\\n365(비빔)\\n3,000\\nP.3,500","","가츠엔","가츠엔(싱푸)","가츠엔","","","",""],["","","","P.고구마돈가스(돈육:국내산)*소스","P.해물잡탕밥(오징어:칠레산/국내산)","쉬림프로제파스타","","","",""],["","","","쌀밥/브로콜리스프","계란팟국","마늘바게뜨/그린샐러드*드레싱","","","",""],["","","","그린샐러드*드레싱","꿔바로우(돈육:국내산)","오이피클/할라피뇨","","","",""],["","","","오이피클/포기김치","짜사이채/포기김치","콜라/사이다","","","",""],["","","","","","","","","",""],["","Snap \\nSnack","라면\\n2,500","수제비라면","꼬치어묵라면","참깨라면","","","",""],["","","떡볶이\\n2,500","떡볶이set","","떡볶이set","","","",""],["","","스낵\\n3,000","후라이드치킨set(계육:국내산)","닭강정set(계육:브라질산)","후라이드치킨set(계육:국내산)","","","",""],["","Take\\nme\\nout","과일팩\\n2,500","과일 4종","과일 4종","과일 4종","","","",""],["","","","(파인애플,토마토,사과,거봉)","(파인애플,토마토,키위,오렌지)","(파인애플,토마토,자몽,거봉)","","","",""],["","","착즙주스\\n3,000","BBQ블로우아웃","오스트레일리아","클린그린엘릭서","","","",""],["","","Healthy\\nBOX\\n3,000","포크커틀릿샐러드(돈육:국내산)","리코타치즈샐러드","두부견과류샐러드","","","",""],["","","","채소주먹밥","고구마버터구이","찐메추리알","","","",""],["","","","거봉","오렌지","파인애플","","","",""],["","","","* 우리 식당은 국내산 쌀-밥,누룽지,죽(흑미, 현미, 찹쌀류 포함)과 김치류(배추:국내산,고추가루:국내산), 두부류(콩:수입산), 콩비지(콩:수입산)만 사용합니다.","","","","조식- 06:30~07:40","",""],["","","","* 상기 메뉴는 식자재 수급상황에 따라 변경될 수 있습니다. ","","","","중식- 12:00~13:00","",""],["","","","* 특정식품에 알러지(Allergy)가 있는 고객께서는 메뉴 선택 전, 식당사무실로 연락주시기 바랍니다.","","","","석식- 17:30~19:00","",""],["","","","","","","","","",""],["","","","","","","","","",""],["","","","","","","","","",""],["","","","","","","","","",""],["","","","","","","","","",""]]');
		hot.loadData(exampleData);
	});

	var PRICE_CLEANSING_REGEXP = /P?[0-9],[0-9]+/g;
	var FOOD_CLEANSING_REGEXP = /(^P\.)|(\(.*?산.*?\))/g;
	var CORNER_NAME_REGEXP = /(탕맛기픈)|(추가배식대)|(Health[\s\n]+Giving[\s\n]+365)|(Snap[\s\n]+Snack)|(Take[\s\n]+me[\s\n]+out)|(도담찌개)|(가츠엔)|(싱푸차이나)/g;

	$("#convert").click(function() {

		var data = hot.getData();

		data = _.chain(data)

		// 첫 줄 제거
		.rest(1)

		// 안내문구 제거
		.filter(function(e) {
			return _.every(e, function(text) {

				if( text.indexOf("우리 식당") > -1 ) {
					return false;
				}
				if( text.indexOf("상기 메뉴") > -1 ) {
					return false;
				}
				if( text.indexOf("특정식품") > -1 ) {
					return false;
				}
				return true;
			});
		})

		// 모든 줄이 비어 있는 것 제거
		.filter(function(e) {
			return _.any(e, function(ee) {
				return !!ee;
			});
		})

		// 금액,원산지 제거
		.map(function(e) {
			e = _.map(e, function(ee) {
				return ee.replace(/[\n\s]+/g, " ").trim();
			})
			e[1] = e[1].replace(PRICE_CLEANSING_REGEXP, "").trim();
			e[2] = e[2].replace(PRICE_CLEANSING_REGEXP, "").trim();
			e[3] = e[3].replace(FOOD_CLEANSING_REGEXP, "").trim();
			e[4] = e[4].replace(FOOD_CLEANSING_REGEXP, "").trim();
			e[5] = e[5].replace(FOOD_CLEANSING_REGEXP, "").trim();
			e[6] = e[6].replace(FOOD_CLEANSING_REGEXP, "").trim();
			e[7] = e[7].replace(FOOD_CLEANSING_REGEXP, "").trim();
			return e;
		})

		.map(function(e, i, list) {
			if( e[0] && e[0].startsWith("Morning") ) {
				e[0] = "breakfast";
			}
			else if( e[0] && e[0].startsWith("Lunch") ) {
				e[0] = "lunch";
			}
			else if( e[0] && e[0].startsWith("Dinner") ) {
				e[0] = "dinner";
			}
			else if( i > 0 ) {
				e[0] = list[i-1][0];
			}

			// // 매일 corner가 달라지는 경우 표시
			// if( e[1].indexOf("or") > -1 ) {
			// 	e[2] = "corner";
			// }

			// corner명 정제
			var cornerArray = e[1].match(CORNER_NAME_REGEXP);
			if( cornerArray ) {
				e[1] = _.map(cornerArray, function(cornerRawFormat) {
					return cornerRawFormat.replace(/[\n\s]+/g, " ").trim();	// 공백/줄바꿈 합치고, 트림
				}).join(",");
			}

			// 윗줄 기반으로 아랫줄 채워서 빈칸 없게 만들기
			if( i > 0 ) {
				if( !e[1] ) {
					e[1] = list[i-1][1];
					if( !e[2] ) {
						e[2] = list[i-1][2];
					}
				}
				else {
				}
			}
			e.splice(3,0,"");
			return e;
		})
		.value();

		data = _.chain(data)
			.groupBy(function(e) {
				return e[0] + "_" + e[1] + "_" + e[2];
			})
			.mapObject(function(menu) {
				var cornerName = null;
				if( menu[0][1].indexOf(",") > -1 ) {
					cornerName = menu[0];
					cornerName[3] = "corner";
					menu = menu.slice(1);
				}
				menu[0][3] = "title";
				if( menu[1] ) {
					 menu[1] = _.reduce(menu.slice(1), function(descriptionMemo, descriptionArray) {
						 return _.chain(descriptionMemo)
						 	.zip(descriptionArray)
							.map(function(desciprtionZip) {
								if( desciprtionZip[0] === desciprtionZip[1] ) {
									return desciprtionZip[0];
								}
								else {
									return desciprtionZip.join(",");
								}
							})
							.value();
					});
					menu[1][3] = "description";
				}

				menu = menu.slice(0,2);

				if( cornerName ) {
					menu.push(cornerName);
				}
				return menu;
			})
			.values()
			.flatten(true)
			.value();

		data[0][0] = "time";
		data[0][1] = "corner";
		data[0][2] = "item";

		var makeYMD = function(text) {
			return moment(text, "M/DD").format("YYYYMMDD");	//ex 1/27 (금)
		}

		data[0][4] = makeYMD(data[0][4]);
		data[0][5] = makeYMD(data[0][5]);
		data[0][6] = makeYMD(data[0][6]);
		data[0][7] = makeYMD(data[0][7]);
		data[0][8] = makeYMD(data[0][8]);

		hot.loadData(data);
	});

	$("#send").click(function() {

		var data = hot.getData();

		var header = data[0];

		var makeSchedule = function(data, index) {
			return _.chain(hot.getData().slice(1))
				.groupBy(function(e) {
					return e[0] + "_" + e[1] + "_" + e[2];
				})
				.mapObject(function(menu){

					var menuObj = {
							time: menu[0][0],
							corner: menu[0][1],
							title_kor: menu[0][index]
						};
					if( menu[1] ) {
						menuObj.description = menu[1][index];
					}
					if( menu[2] ) {
						menuObj.corner = menu[2][index];
					}
					return menuObj;
				})
				.values()
				.flatten(true)
				.value();
			
		};

		var schedule = {};
		schedule[header[4]] = makeSchedule(data, 4);
		schedule[header[5]] = makeSchedule(data, 5);
		schedule[header[6]] = makeSchedule(data, 6);
		schedule[header[7]] = makeSchedule(data, 7);
		schedule[header[8]] = makeSchedule(data, 8);

		console.log(schedule);

		_.each(schedule, function(e, i) {
			$.ajax({
					type: "POST",
					url: '/pangyo/' + i,
					data: JSON.stringify(e),
					contentType: 'application/json; charset=UTF-8'
				});
		});

	});
});
</script>
</body>
</html>
